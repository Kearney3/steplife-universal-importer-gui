name: Release

on:
  push:
    tags:
      - 'v*'  # åŒ¹é…æ‰€æœ‰ä»¥ v å¼€å¤´çš„ tagï¼Œå¦‚ v1.0.0

jobs:
  build:
    name: Build and Release
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€è¦æƒé™æ¥åˆ›å»º release å’Œä¸Šä¼ æ–‡ä»¶
    
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
          - goos: windows
            goarch: amd64
          - goos: windows
            goarch: arm64
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.2'
      
      - name: Extract app info
        id: app_info
        run: |
          # ä» consts.go æå–åº”ç”¨åç§°ï¼ˆå…¼å®¹æ‰€æœ‰ç³»ç»Ÿï¼‰
          APP_NAME=$(grep 'AppName = ' internal/const/consts.go | sed 's/.*AppName = "\(.*\)".*/\1/' | head -1)
          if [ -z "$APP_NAME" ]; then
            echo "Error: Could not extract AppName from consts.go"
            exit 1
          fi
          
          # ä» consts.go æå–ç‰ˆæœ¬å·ï¼ˆå…¼å®¹æ‰€æœ‰ç³»ç»Ÿï¼‰
          VERSION=$(grep 'Version = ' internal/const/consts.go | sed 's/.*Version = "\(.*\)".*/\1/' | head -1)
          if [ -z "$VERSION" ]; then
            echo "Error: Could not extract Version from consts.go"
            exit 1
          fi
          
          # ä» go.mod è·å–æ¨¡å—åï¼Œç”¨äºç”Ÿæˆ Bundle ID
          MODULE_NAME=$(grep '^module ' go.mod | awk '{print $2}')
          BUNDLE_ID=$(echo "$MODULE_NAME" | tr '/' '.')
          
          # ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶åï¼ˆåŸºäºæ¨¡å—åï¼‰
          EXECUTABLE_NAME=$(basename "$MODULE_NAME")
          
          echo "APP_NAME=$APP_NAME" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "BUNDLE_ID=$BUNDLE_ID" >> $GITHUB_OUTPUT
          echo "EXECUTABLE_NAME=$EXECUTABLE_NAME" >> $GITHUB_OUTPUT
          
          echo "Extracted app info:"
          echo "  App Name: $APP_NAME"
          echo "  Version: $VERSION"
          echo "  Bundle ID: $BUNDLE_ID"
          echo "  Executable Name: $EXECUTABLE_NAME"
      
      - name: Prepare Windows icon
        if: matrix.goos == 'windows'
        run: |
          # æ£€æŸ¥å›¾æ ‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f "internal/gui/resources/icon.ico" ]; then
            echo "Processing Windows icon..."
            
            # å®‰è£… rsrc å·¥å…·
            go install github.com/akavel/rsrc@latest
            
            # ç”Ÿæˆèµ„æºæ–‡ä»¶
            rsrc -ico internal/gui/resources/icon.ico -o rsrc_windows_${{ matrix.goarch }}.syso
            
            if [ -f "rsrc_windows_${{ matrix.goarch }}.syso" ]; then
              echo "Windows icon resource file created: rsrc_windows_${{ matrix.goarch }}.syso"
            else
              echo "Warning: Failed to create resource file"
            fi
          else
            echo "Warning: icon.ico not found, skipping icon embedding"
          fi
      
      - name: Build
        id: build
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          # åŠ¨æ€ç”Ÿæˆè¾“å‡ºæ–‡ä»¶åï¼ˆåŸºäºæ¨¡å—åï¼‰
          EXECUTABLE_NAME="${{ steps.app_info.outputs.EXECUTABLE_NAME }}"
          OUTPUT_FILE="${EXECUTABLE_NAME}-${{ matrix.goos }}-${{ matrix.goarch }}"
          
          # Windows å¹³å°æ·»åŠ  .exe æ‰©å±•å
          if [ "${{ matrix.goos }}" == "windows" ]; then
            OUTPUT_FILE="${OUTPUT_FILE}.exe"
          fi
          
          # æ„å»º
          go build -tags=embed_font -trimpath -ldflags="-s -w" -o "${OUTPUT_FILE}" ./cmd
          
          # å°†è¾“å‡ºæ–‡ä»¶åä¿å­˜ä¸ºæ­¥éª¤è¾“å‡ºï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "OUTPUT_FILE=${OUTPUT_FILE}" >> $GITHUB_OUTPUT
          
          # æ¸…ç†èµ„æºæ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ "${{ matrix.goos }}" == "windows" ]; then
            rm -f rsrc_windows_*.syso 2>/dev/null || true
          fi
      
      - name: Create macOS .app bundle
        if: matrix.goos == 'darwin'
        id: create_app_bundle
        run: |
          APP_NAME="${{ steps.app_info.outputs.APP_NAME }}"
          VERSION="${{ steps.app_info.outputs.VERSION }}"
          BUNDLE_ID="${{ steps.app_info.outputs.BUNDLE_ID }}"
          EXECUTABLE_NAME="${{ steps.app_info.outputs.EXECUTABLE_NAME }}"
          
          # ç”Ÿæˆ .app åç§°ï¼ˆåº”ç”¨åç§°-æ¶æ„.appï¼‰
          APP_BUNDLE_NAME="${APP_NAME}-${{ matrix.goarch }}.app"
          
          # åˆ›å»º .app ç›®å½•ç»“æ„
          mkdir -p "${APP_BUNDLE_NAME}/Contents/MacOS"
          mkdir -p "${APP_BUNDLE_NAME}/Contents/Resources"
          
          # ç§»åŠ¨å¯æ‰§è¡Œæ–‡ä»¶åˆ° MacOS ç›®å½•
          mv "${{ steps.build.outputs.OUTPUT_FILE }}" "${APP_BUNDLE_NAME}/Contents/MacOS/${EXECUTABLE_NAME}"
          chmod +x "${APP_BUNDLE_NAME}/Contents/MacOS/${EXECUTABLE_NAME}"
          
          # å¤åˆ¶å›¾æ ‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          ICON_FILE=""
          if [ -f "internal/gui/resources/icon.png" ]; then
            cp "internal/gui/resources/icon.png" "${APP_BUNDLE_NAME}/Contents/Resources/icon.png"
            ICON_FILE="icon"
          fi
          
          # åˆ›å»º Info.plist
          printf '<?xml version="1.0" encoding="UTF-8"?>\n<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">\n<plist version="1.0">\n<dict>\n  <key>CFBundleExecutable</key>\n  <string>%s</string>\n  <key>CFBundleIdentifier</key>\n  <string>%s</string>\n  <key>CFBundleName</key>\n  <string>%s</string>\n  <key>CFBundleDisplayName</key>\n  <string>%s</string>\n  <key>CFBundleVersion</key>\n  <string>%s</string>\n  <key>CFBundleShortVersionString</key>\n  <string>%s</string>\n  <key>CFBundlePackageType</key>\n  <string>APPL</string>\n  <key>CFBundleSignature</key>\n  <string>????</string>\n  <key>LSMinimumSystemVersion</key>\n  <string>10.13</string>\n  <key>NSHighResolutionCapable</key>\n  <true/>%s\n</dict>\n</plist>\n' \
            "${EXECUTABLE_NAME}" \
            "${BUNDLE_ID}" \
            "${APP_NAME}" \
            "${APP_NAME}" \
            "${VERSION}" \
            "${VERSION}" \
            "$([ -n "$ICON_FILE" ] && printf '\n  <key>CFBundleIconFile</key>\n  <string>%s</string>' "$ICON_FILE" || echo '')" \
            > "${APP_BUNDLE_NAME}/Contents/Info.plist"
          
          echo "Created ${APP_BUNDLE_NAME}"
          echo "App Name: ${APP_NAME}"
          echo "Version: ${VERSION}"
          ls -lh "${APP_BUNDLE_NAME}/Contents/MacOS/"
          
          # å°† .app åç§°ä¿å­˜ä¸ºæ­¥éª¤è¾“å‡ºï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "APP_BUNDLE_NAME=${APP_BUNDLE_NAME}" >> $GITHUB_OUTPUT
      
      - name: Upload artifact (macOS)
        if: matrix.goos == 'darwin'
        id: upload_macos
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.create_app_bundle.outputs.APP_BUNDLE_NAME }}
          path: ${{ steps.create_app_bundle.outputs.APP_BUNDLE_NAME }}
          retention-days: 1
      
      - name: Upload artifact (other platforms)
        if: matrix.goos != 'darwin'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.OUTPUT_FILE }}
          path: ${{ steps.build.outputs.OUTPUT_FILE }}
          retention-days: 1
  
  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
      
      - name: Get tag name
        id: tag
        run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Extract app info for release notes
        id: release_info
        run: |
          # ä» consts.go æå–åº”ç”¨åç§°
          APP_NAME=$(grep 'AppName = ' internal/const/consts.go | sed 's/.*AppName = "\(.*\)".*/\1/' | head -1)
          
          # ä» consts.go æå–ç‰ˆæœ¬å·
          VERSION=$(grep 'Version = ' internal/const/consts.go | sed 's/.*Version = "\(.*\)".*/\1/' | head -1)
          
          # ä» go.mod è·å–æ¨¡å—åï¼Œç”¨äºç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶å
          MODULE_NAME=$(grep '^module ' go.mod | awk '{print $2}')
          EXECUTABLE_NAME=$(basename "$MODULE_NAME")
          
          echo "APP_NAME=$APP_NAME" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "EXECUTABLE_NAME=$EXECUTABLE_NAME" >> $GITHUB_OUTPUT
      
      - name: Generate release notes
        id: release_notes
        run: |
          APP_NAME="${{ steps.release_info.outputs.APP_NAME }}"
          VERSION="${{ steps.release_info.outputs.VERSION }}"
          EXECUTABLE_NAME="${{ steps.release_info.outputs.EXECUTABLE_NAME }}"
          TAG_NAME="${{ steps.tag.outputs.tag }}"
          
          # ç”Ÿæˆæ–‡ä»¶å
          WIN_AMD64="${EXECUTABLE_NAME}-windows-amd64.exe"
          WIN_ARM64="${EXECUTABLE_NAME}-windows-arm64.exe"
          MACOS_AMD64="${APP_NAME}-amd64.app"
          MACOS_ARM64="${APP_NAME}-arm64.app"
          LINUX_AMD64="${EXECUTABLE_NAME}-linux-amd64"
          LINUX_ARM64="${EXECUTABLE_NAME}-linux-arm64"
          
          cat > release_notes.md <<RELEASE_NOTES_EOF
          # ${APP_NAME} ${TAG_NAME}
          
          ## ğŸ“¦ ä¸‹è½½è¯´æ˜
          
          | å¹³å° | æ¶æ„ | æ–‡ä»¶å | ä½¿ç”¨æ–¹æ³• |
          |------|------|--------|---------|
          | Windows | amd64 | \`${WIN_AMD64}\` | åŒå‡»è¿è¡Œï¼Œé¦–æ¬¡éœ€å…è®¸æƒé™ |
          | Windows | arm64 | \`${WIN_ARM64}\` | åŒå‡»è¿è¡Œï¼Œé¦–æ¬¡éœ€å…è®¸æƒé™ |
          | macOS | amd64 | \`${MACOS_AMD64}\` | åŒå‡»æ‰“å¼€ï¼Œé¦–æ¬¡éœ€åœ¨ç³»ç»Ÿè®¾ç½®ä¸­å…è®¸ |
          | macOS | arm64 | \`${MACOS_ARM64}\` | åŒå‡»æ‰“å¼€ï¼Œé¦–æ¬¡éœ€åœ¨ç³»ç»Ÿè®¾ç½®ä¸­å…è®¸ |
          | Linux | amd64 | \`${LINUX_AMD64}\` | \`chmod +x\` åè¿è¡Œï¼ŒGUI æ¨¡å¼é»˜è®¤ï¼ŒCLI æ¨¡å¼åŠ  \`--cli\` |
          | Linux | arm64 | \`${LINUX_ARM64}\` | \`chmod +x\` åè¿è¡Œï¼ŒGUI æ¨¡å¼é»˜è®¤ï¼ŒCLI æ¨¡å¼åŠ  \`--cli\` |
          
          ## ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          
          | å¹³å° | æœ€ä½ç‰ˆæœ¬ |
          |------|---------|
          | Windows | Windows 10 (64ä½) |
          | macOS | macOS 10.13 |
          | Linux | æ”¯æŒ GTK3 çš„ç°ä»£å‘è¡Œç‰ˆ |
          
          **ç‰ˆæœ¬ï¼š** ${VERSION}  
          **å‘å¸ƒæ—¥æœŸï¼š** $(date +'%Y-%m-%d')
          RELEASE_NOTES_EOF
          
          # æ˜¾ç¤ºç”Ÿæˆçš„ release notes
          cat release_notes.md
      
      - name: Prepare release files
        run: |
          mkdir -p ./release
          
          # éå†æ‰€æœ‰ artifact ç›®å½•
          for artifact_dir in ./artifacts/*/; do
            if [ -d "$artifact_dir" ]; then
              # æ£€æŸ¥æ˜¯å¦æ˜¯ .app ç›®å½•
              app_dir=$(find "$artifact_dir" -maxdepth 1 -type d -name "*.app" | head -1)
              if [ -n "$app_dir" ]; then
                # å¤åˆ¶ .app ç›®å½•
                appname=$(basename "$app_dir")
                cp -R "$app_dir" "./release/$appname"
                echo "Copied .app bundle: $appname"
              else
                # å¤åˆ¶å…¶ä»–æ–‡ä»¶ï¼ˆLinux å’Œ Windows å¯æ‰§è¡Œæ–‡ä»¶ï¼‰
                find "$artifact_dir" -type f | while read file; do
                  filename=$(basename "$file")
                  cp "$file" "./release/$filename"
                  echo "Copied file: $filename"
                done
              fi
            fi
          done
          
          # ä¸º Linux æ–‡ä»¶æ·»åŠ æ‰§è¡Œæƒé™ï¼ˆä½¿ç”¨é€šé…ç¬¦åŒ¹é…æ‰€æœ‰ Linux å¯æ‰§è¡Œæ–‡ä»¶ï¼‰
          find ./release -type f ! -name "*.exe" ! -name "*.app" -exec chmod +x {} \; 2>/dev/null || true
          
          # æ˜¾ç¤ºæ”¶é›†åˆ°çš„æ–‡ä»¶
          echo ""
          echo "=== Release files ==="
          ls -lh ./release/
          echo ""
          echo "=== .app bundles ==="
          find ./release -name "*.app" -type d -exec du -sh {} \;
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Release ${{ steps.tag.outputs.tag }}
          body_path: release_notes.md
          files: ./release/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
