name: Release

on:
  push:
   tags:
     - 'v*'  # åŒ¹é…æ‰€æœ‰ä»¥ v å¼€å¤´çš„ tagï¼Œå¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ

jobs:
  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€è¦æƒé™æ¥åˆ›å»º release å’Œä¸Šä¼ æ–‡ä»¶
    
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.2'
      
      - name: Install Linux dependencies
        if: matrix.goos == 'linux' && matrix.goarch != 'arm64'
        run: |
          sudo apt-get update
          
          # å¯¹äº amd64ï¼Œå®‰è£…æ ‡å‡†åº“
          sudo apt-get install -y \
            libgl1-mesa-dev \
            libx11-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxcursor-dev \
            libxi-dev \
            libxxf86vm-dev \
            pkg-config
      
      - name: Extract app info
        id: app_info
        run: |
          # ä» consts.go æå–åº”ç”¨åç§°ï¼ˆå…¼å®¹æ‰€æœ‰ç³»ç»Ÿï¼‰
          APP_NAME=$(grep 'AppName = ' internal/const/consts.go | sed 's/.*AppName = "\(.*\)".*/\1/' | head -1)
          if [ -z "$APP_NAME" ]; then
            echo "Error: Could not extract AppName from consts.go"
            exit 1
          fi
          
          # ä» consts.go æå–ç‰ˆæœ¬å·ï¼ˆå…¼å®¹æ‰€æœ‰ç³»ç»Ÿï¼‰
          VERSION=$(grep 'Version = ' internal/const/consts.go | sed 's/.*Version = "\(.*\)".*/\1/' | head -1)
          if [ -z "$VERSION" ]; then
            echo "Error: Could not extract Version from consts.go"
            exit 1
          fi
          
          # ä» go.mod è·å–æ¨¡å—åï¼Œç”¨äºç”Ÿæˆ Bundle ID
          MODULE_NAME=$(grep '^module ' go.mod | awk '{print $2}')
          BUNDLE_ID=$(echo "$MODULE_NAME" | tr '/' '.')
          
          # ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶åï¼ˆåŸºäºæ¨¡å—åï¼‰
          EXECUTABLE_NAME=$(basename "$MODULE_NAME")
          
          echo "APP_NAME=$APP_NAME" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "BUNDLE_ID=$BUNDLE_ID" >> $GITHUB_OUTPUT
          echo "EXECUTABLE_NAME=$EXECUTABLE_NAME" >> $GITHUB_OUTPUT
          
          echo "Extracted app info:"
          echo "  App Name: $APP_NAME"
          echo "  Version: $VERSION"
          echo "  Bundle ID: $BUNDLE_ID"
          echo "  Executable Name: $EXECUTABLE_NAME"
      
      - name: Set up QEMU
        if: matrix.goos == 'linux' && matrix.goarch == 'arm64'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
      
      - name: Prepare Windows icon
        if: matrix.goos == 'windows'
        run: |
          # æ£€æŸ¥å›¾æ ‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f "internal/gui/resources/icon.ico" ]; then
            echo "Processing Windows icon..."
            
            # å®‰è£… rsrc å·¥å…·
            go install github.com/akavel/rsrc@latest
            
            # ç”Ÿæˆèµ„æºæ–‡ä»¶
            rsrc -ico internal/gui/resources/icon.ico -o rsrc_windows_${{ matrix.goarch }}.syso
            
            if [ -f "rsrc_windows_${{ matrix.goarch }}.syso" ]; then
              echo "Windows icon resource file created: rsrc_windows_${{ matrix.goarch }}.syso"
            else
              echo "Warning: Failed to create resource file"
            fi
          else
            echo "Warning: icon.ico not found, skipping icon embedding"
          fi
      
      - name: Build (using Docker for ARM64 Linux)
        if: matrix.goos == 'linux' && matrix.goarch == 'arm64'
        id: build_docker
        run: |
          # åŠ¨æ€ç”Ÿæˆè¾“å‡ºæ–‡ä»¶åï¼ˆåŸºäºæ¨¡å—åï¼‰
          EXECUTABLE_NAME="${{ steps.app_info.outputs.EXECUTABLE_NAME }}"
          OUTPUT_FILE="${EXECUTABLE_NAME}-${{ matrix.goos }}-${{ matrix.goarch }}"
          
          # ä½¿ç”¨ Docker åœ¨ ARM64 å®¹å™¨ä¸­æ„å»º
          docker run --rm \
            -v "$PWD:/workspace" \
            -w /workspace \
            -e GOOS=linux \
            -e GOARCH=arm64 \
            -e CGO_ENABLED=1 \
            --platform linux/arm64 \
            -u root:root \
            golang:1.24.2 \
            bash -c "
              apt-get update && \
              apt-get install -y \
                libgl1-mesa-dev \
                libx11-dev \
                libxrandr-dev \
                libxinerama-dev \
                libxcursor-dev \
                libxi-dev \
                libxxf86vm-dev \
                pkg-config \
                gcc && \
              go build -buildvcs=false -tags=embed_font -trimpath -ldflags='-s -w' -o ${OUTPUT_FILE} ./cmd && \
              chmod 755 ${OUTPUT_FILE}
            "
          
          # ç¡®ä¿æ–‡ä»¶æƒé™æ­£ç¡®ï¼ˆDocker å¯èƒ½åˆ›å»º root æ‹¥æœ‰çš„æ–‡ä»¶ï¼‰
          sudo chown $USER:$USER "${OUTPUT_FILE}" || true
          chmod +x "${OUTPUT_FILE}" || true
          
          # å°†è¾“å‡ºæ–‡ä»¶åä¿å­˜ä¸ºæ­¥éª¤è¾“å‡º
          echo "OUTPUT_FILE=${OUTPUT_FILE}" >> $GITHUB_OUTPUT
      
      - name: Build (native build)
        if: matrix.goarch != 'arm64'
        id: build
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 1
        run: |
          # åŠ¨æ€ç”Ÿæˆè¾“å‡ºæ–‡ä»¶åï¼ˆåŸºäºæ¨¡å—åï¼‰
          EXECUTABLE_NAME="${{ steps.app_info.outputs.EXECUTABLE_NAME }}"
          OUTPUT_FILE="${EXECUTABLE_NAME}-${{ matrix.goos }}-${{ matrix.goarch }}"
          
          # æ„å»º
          go build -tags=embed_font -trimpath -ldflags="-s -w" -o "${OUTPUT_FILE}" ./cmd
          
          # å°†è¾“å‡ºæ–‡ä»¶åä¿å­˜ä¸ºæ­¥éª¤è¾“å‡ºï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "OUTPUT_FILE=${OUTPUT_FILE}" >> $GITHUB_OUTPUT
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build_docker.outputs.OUTPUT_FILE || steps.build.outputs.OUTPUT_FILE }}
          path: ${{ steps.build_docker.outputs.OUTPUT_FILE || steps.build.outputs.OUTPUT_FILE }}
          retention-days: 1
  
  build-windows-amd64:
    name: Build Windows(amd64)
    runs-on: windows-latest
    permissions:
      contents: write  # éœ€è¦æƒé™æ¥åˆ›å»º release å’Œä¸Šä¼ æ–‡ä»¶
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.2'
      
      - name: Extract app info
        id: app_info
        shell: bash
        run: |
          # ä» consts.go æå–åº”ç”¨åç§°ï¼ˆå…¼å®¹æ‰€æœ‰ç³»ç»Ÿï¼‰
          APP_NAME=$(grep 'AppName = ' internal/const/consts.go | sed 's/.*AppName = "\(.*\)".*/\1/' | head -1)
          if [ -z "$APP_NAME" ]; then
            echo "Error: Could not extract AppName from consts.go"
            exit 1
          fi
          
          # ä» consts.go æå–ç‰ˆæœ¬å·ï¼ˆå…¼å®¹æ‰€æœ‰ç³»ç»Ÿï¼‰
          VERSION=$(grep 'Version = ' internal/const/consts.go | sed 's/.*Version = "\(.*\)".*/\1/' | head -1)
          if [ -z "$VERSION" ]; then
            echo "Error: Could not extract Version from consts.go"
            exit 1
          fi
          
          # ä» go.mod è·å–æ¨¡å—åï¼Œç”¨äºç”Ÿæˆ Bundle ID
          MODULE_NAME=$(grep '^module ' go.mod | awk '{print $2}')
          BUNDLE_ID=$(echo "$MODULE_NAME" | tr '/' '.')
          
          # ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶åï¼ˆåŸºäºæ¨¡å—åï¼‰
          EXECUTABLE_NAME=$(basename "$MODULE_NAME")
          
          echo "APP_NAME=$APP_NAME" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "BUNDLE_ID=$BUNDLE_ID" >> $GITHUB_OUTPUT
          echo "EXECUTABLE_NAME=$EXECUTABLE_NAME" >> $GITHUB_OUTPUT
          
          echo "Extracted app info:"
          echo "  App Name: $APP_NAME"
          echo "  Version: $VERSION"
          echo "  Bundle ID: $BUNDLE_ID"
          echo "  Executable Name: $EXECUTABLE_NAME"
      
      - name: Prepare Windows icon
        shell: bash
        run: |
          # æ£€æŸ¥å›¾æ ‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f "internal/gui/resources/icon.ico" ]; then
            echo "Processing Windows icon..."
            
            # å®‰è£… rsrc å·¥å…·
            go install github.com/akavel/rsrc@latest
            
            # ç”Ÿæˆèµ„æºæ–‡ä»¶
            rsrc -ico internal/gui/resources/icon.ico -o rsrc_windows_amd64.syso
            
            if [ -f "rsrc_windows_amd64.syso" ]; then
              echo "Windows icon resource file created: rsrc_windows_amd64.syso"
            else
              echo "Warning: Failed to create resource file"
            fi
          else
            echo "Warning: icon.ico not found, skipping icon embedding"
          fi
      
      - name: Build
        id: build
        shell: bash
        env:
          GOOS: windows
          GOARCH: amd64
          CGO_ENABLED: 1
        run: |
          # åŠ¨æ€ç”Ÿæˆè¾“å‡ºæ–‡ä»¶åï¼ˆåŸºäºæ¨¡å—åï¼‰
          EXECUTABLE_NAME="${{ steps.app_info.outputs.EXECUTABLE_NAME }}"
          OUTPUT_FILE="${EXECUTABLE_NAME}-windows-amd64.exe"
          
          # æ„å»º
          go build -tags=embed_font -trimpath -ldflags="-s -w" -o "${OUTPUT_FILE}" ./cmd
          
          # å°†è¾“å‡ºæ–‡ä»¶åä¿å­˜ä¸ºæ­¥éª¤è¾“å‡ºï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "OUTPUT_FILE=${OUTPUT_FILE}" >> $GITHUB_OUTPUT
          
          # æ¸…ç†èµ„æºæ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          rm -f rsrc_windows_*.syso 2>/dev/null || true
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.OUTPUT_FILE }}
          path: ${{ steps.build.outputs.OUTPUT_FILE }}
          retention-days: 1
  
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    permissions:
      contents: write  # éœ€è¦æƒé™æ¥åˆ›å»º release å’Œä¸Šä¼ æ–‡ä»¶
    
    strategy:
      matrix:
        include:
          - goarch: amd64
          - goarch: arm64
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.2'
      
      - name: Extract app info
        id: app_info
        run: |
          # ä» consts.go æå–åº”ç”¨åç§°ï¼ˆå…¼å®¹æ‰€æœ‰ç³»ç»Ÿï¼‰
          APP_NAME=$(grep 'AppName = ' internal/const/consts.go | sed 's/.*AppName = "\(.*\)".*/\1/' | head -1)
          if [ -z "$APP_NAME" ]; then
            echo "Error: Could not extract AppName from consts.go"
            exit 1
          fi
          
          # ä» consts.go æå–ç‰ˆæœ¬å·ï¼ˆå…¼å®¹æ‰€æœ‰ç³»ç»Ÿï¼‰
          VERSION=$(grep 'Version = ' internal/const/consts.go | sed 's/.*Version = "\(.*\)".*/\1/' | head -1)
          if [ -z "$VERSION" ]; then
            echo "Error: Could not extract Version from consts.go"
            exit 1
          fi
          
          # ä» go.mod è·å–æ¨¡å—åï¼Œç”¨äºç”Ÿæˆ Bundle ID
          MODULE_NAME=$(grep '^module ' go.mod | awk '{print $2}')
          BUNDLE_ID=$(echo "$MODULE_NAME" | tr '/' '.')
          
          # ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶åï¼ˆåŸºäºæ¨¡å—åï¼‰
          EXECUTABLE_NAME=$(basename "$MODULE_NAME")
          
          echo "APP_NAME=$APP_NAME" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "BUNDLE_ID=$BUNDLE_ID" >> $GITHUB_OUTPUT
          echo "EXECUTABLE_NAME=$EXECUTABLE_NAME" >> $GITHUB_OUTPUT
          
          echo "Extracted app info:"
          echo "  App Name: $APP_NAME"
          echo "  Version: $VERSION"
          echo "  Bundle ID: $BUNDLE_ID"
          echo "  Executable Name: $EXECUTABLE_NAME"
      
      - name: Build
        id: build
        env:
          GOOS: darwin
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 1
        run: |
          # åŠ¨æ€ç”Ÿæˆè¾“å‡ºæ–‡ä»¶åï¼ˆåŸºäºæ¨¡å—åï¼‰
          EXECUTABLE_NAME="${{ steps.app_info.outputs.EXECUTABLE_NAME }}"
          OUTPUT_FILE="${EXECUTABLE_NAME}-darwin-${{ matrix.goarch }}"
          
          # å¯¹äºäº¤å‰ç¼–è¯‘ï¼ˆåœ¨ Apple Silicon ä¸Šæ„å»º amd64ï¼‰ï¼Œéœ€è¦è®¾ç½® SDK è·¯å¾„
          if [ "${{ matrix.goarch }}" == "amd64" ] && [ "$(uname -m)" == "arm64" ]; then
            # è®¾ç½® macOS SDK è·¯å¾„ï¼ˆç”¨äºäº¤å‰ç¼–è¯‘ï¼‰
            export SDKROOT=$(xcrun --show-sdk-path)
            # ä½¿ç”¨ x86_64 æ¶æ„çš„ clangï¼ˆç”¨äºäº¤å‰ç¼–è¯‘ï¼‰
            export CC="$(xcrun --find clang) -arch x86_64"
            export CXX="$(xcrun --find clang++) -arch x86_64"
          fi
          
          # æ˜¾ç¤ºæ„å»ºä¿¡æ¯
          echo "Building for GOOS=darwin GOARCH=${{ matrix.goarch }}"
          echo "CGO_ENABLED=$CGO_ENABLED"
          if [ -n "$CC" ]; then
            echo "CC=$CC"
          fi
          
          # æ„å»ºï¼ˆæ˜ç¡®è®¾ç½® GOOS=darwin å’Œ GOARCHï¼Œå¯ç”¨ CGOï¼‰
          go build -tags=embed_font -trimpath -ldflags="-s -w" -o "${OUTPUT_FILE}" ./cmd
          
          # å°†è¾“å‡ºæ–‡ä»¶åä¿å­˜ä¸ºæ­¥éª¤è¾“å‡ºï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "OUTPUT_FILE=${OUTPUT_FILE}" >> $GITHUB_OUTPUT
      
      - name: Create macOS .app bundle
        id: create_app_bundle
        run: |
          APP_NAME="${{ steps.app_info.outputs.APP_NAME }}"
          VERSION="${{ steps.app_info.outputs.VERSION }}"
          BUNDLE_ID="${{ steps.app_info.outputs.BUNDLE_ID }}"
          EXECUTABLE_NAME="${{ steps.app_info.outputs.EXECUTABLE_NAME }}"
          
          # ç”Ÿæˆ .app åç§°ï¼ˆä½¿ç”¨å¯æ‰§è¡Œæ–‡ä»¶å-æ¶æ„.appï¼‰
          APP_BUNDLE_NAME="${EXECUTABLE_NAME}-darwin-${{ matrix.goarch }}.app"
          
          # åˆ›å»º .app ç›®å½•ç»“æ„
          mkdir -p "${APP_BUNDLE_NAME}/Contents/MacOS"
          mkdir -p "${APP_BUNDLE_NAME}/Contents/Resources"
          
          # ç§»åŠ¨å¯æ‰§è¡Œæ–‡ä»¶åˆ° MacOS ç›®å½•
          mv "${{ steps.build.outputs.OUTPUT_FILE }}" "${APP_BUNDLE_NAME}/Contents/MacOS/${EXECUTABLE_NAME}"
          chmod +x "${APP_BUNDLE_NAME}/Contents/MacOS/${EXECUTABLE_NAME}"
          
          # å¤åˆ¶å›¾æ ‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          ICON_FILE=""
          if [ -f "internal/gui/resources/icon.png" ]; then
            cp "internal/gui/resources/icon.png" "${APP_BUNDLE_NAME}/Contents/Resources/icon.png"
            ICON_FILE="icon"
          fi
          
          # åˆ›å»º Info.plist
          printf '<?xml version="1.0" encoding="UTF-8"?>\n<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">\n<plist version="1.0">\n<dict>\n  <key>CFBundleExecutable</key>\n  <string>%s</string>\n  <key>CFBundleIdentifier</key>\n  <string>%s</string>\n  <key>CFBundleName</key>\n  <string>%s</string>\n  <key>CFBundleDisplayName</key>\n  <string>%s</string>\n  <key>CFBundleVersion</key>\n  <string>%s</string>\n  <key>CFBundleShortVersionString</key>\n  <string>%s</string>\n  <key>CFBundlePackageType</key>\n  <string>APPL</string>\n  <key>CFBundleSignature</key>\n  <string>????</string>\n  <key>LSMinimumSystemVersion</key>\n  <string>10.13</string>\n  <key>NSHighResolutionCapable</key>\n  <true/>%s\n</dict>\n</plist>\n' \
            "${EXECUTABLE_NAME}" \
            "${BUNDLE_ID}" \
            "${APP_NAME}" \
            "${APP_NAME}" \
            "${VERSION}" \
            "${VERSION}" \
            "$([ -n "$ICON_FILE" ] && printf '\n  <key>CFBundleIconFile</key>\n  <string>%s</string>' "$ICON_FILE" || echo '')" \
            > "${APP_BUNDLE_NAME}/Contents/Info.plist"
          
          echo "Created ${APP_BUNDLE_NAME}"
          echo "App Name: ${APP_NAME}"
          echo "Version: ${VERSION}"
          ls -lh "${APP_BUNDLE_NAME}/Contents/MacOS/"
          
          # å°† .app åç§°ä¿å­˜ä¸ºæ­¥éª¤è¾“å‡ºï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "APP_BUNDLE_NAME=${APP_BUNDLE_NAME}" >> $GITHUB_OUTPUT
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.create_app_bundle.outputs.APP_BUNDLE_NAME }}
          path: ${{ steps.create_app_bundle.outputs.APP_BUNDLE_NAME }}
          retention-days: 1
  
  release:
    name: Create Release
    needs: [build-linux, build-windows-amd64, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
      
      - name: Get tag name
        id: tag
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # ä» tag è§¦å‘ï¼Œæå– tag å
            TAG_NAME="${GITHUB_REF#refs/tags/}"
          else
            # æ‰‹åŠ¨è§¦å‘æˆ–å…¶ä»–æƒ…å†µï¼Œä½¿ç”¨ç‰ˆæœ¬å·ä½œä¸º tag å
            VERSION=$(grep 'Version = ' internal/const/consts.go | sed 's/.*Version = "\(.*\)".*/\1/' | head -1)
            TAG_NAME="v${VERSION}"
          fi
          echo "tag=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "Tag name: ${TAG_NAME}"
      
      - name: Extract app info for release notes
        id: release_info
        run: |
          # ä» consts.go æå–åº”ç”¨åç§°
          APP_NAME=$(grep 'AppName = ' internal/const/consts.go | sed 's/.*AppName = "\(.*\)".*/\1/' | head -1)
          
          # ä» consts.go æå–ç‰ˆæœ¬å·
          VERSION=$(grep 'Version = ' internal/const/consts.go | sed 's/.*Version = "\(.*\)".*/\1/' | head -1)
          
          # ä» go.mod è·å–æ¨¡å—åï¼Œç”¨äºç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶å
          MODULE_NAME=$(grep '^module ' go.mod | awk '{print $2}')
          EXECUTABLE_NAME=$(basename "$MODULE_NAME")
          
          echo "APP_NAME=$APP_NAME" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "EXECUTABLE_NAME=$EXECUTABLE_NAME" >> $GITHUB_OUTPUT
      
      - name: Generate release notes
        id: release_notes
        run: |
          APP_NAME="${{ steps.release_info.outputs.APP_NAME }}"
          VERSION="${{ steps.release_info.outputs.VERSION }}"
          EXECUTABLE_NAME="${{ steps.release_info.outputs.EXECUTABLE_NAME }}"
          TAG_NAME="${{ steps.tag.outputs.tag }}"
          
          # ç”Ÿæˆæ–‡ä»¶åï¼ˆç»Ÿä¸€ä½¿ç”¨ EXECUTABLE_NAMEï¼‰
          WIN_AMD64="${EXECUTABLE_NAME}-windows-amd64.exe"
          MACOS_AMD64="${EXECUTABLE_NAME}-darwin-amd64.app.zip"
          MACOS_ARM64="${EXECUTABLE_NAME}-darwin-arm64.app.zip"
          LINUX_AMD64="${EXECUTABLE_NAME}-linux-amd64"
          LINUX_ARM64="${EXECUTABLE_NAME}-linux-arm64"
          
          cat > release_notes.md <<RELEASE_NOTES_EOF
          # ${APP_NAME} ${TAG_NAME}
          
          ## ğŸ“¦ ä¸‹è½½è¯´æ˜
          
          | å¹³å° | æ¶æ„ | æ–‡ä»¶å | ä½¿ç”¨æ–¹æ³• |
          |------|------|--------|---------|
          | Windows | amd64 | \`${WIN_AMD64}\` | åŒå‡»è¿è¡Œï¼Œé¦–æ¬¡éœ€å…è®¸æƒé™ |
          | macOS | amd64 | \`${MACOS_AMD64}\` | ä¸‹è½½åè§£å‹ï¼ŒåŒå‡» .app æ‰“å¼€ï¼Œé¦–æ¬¡éœ€åœ¨ç³»ç»Ÿè®¾ç½®ä¸­å…è®¸ |
          | macOS | arm64 | \`${MACOS_ARM64}\` | ä¸‹è½½åè§£å‹ï¼ŒåŒå‡» .app æ‰“å¼€ï¼Œé¦–æ¬¡éœ€åœ¨ç³»ç»Ÿè®¾ç½®ä¸­å…è®¸ |
          | Linux | amd64 | \`${LINUX_AMD64}\` | \`chmod +x\` åè¿è¡Œï¼ŒGUI æ¨¡å¼é»˜è®¤ï¼ŒCLI æ¨¡å¼åŠ  \`--cli\` |
          | Linux | arm64 | \`${LINUX_ARM64}\` | \`chmod +x\` åè¿è¡Œï¼ŒGUI æ¨¡å¼é»˜è®¤ï¼ŒCLI æ¨¡å¼åŠ  \`--cli\` |
          
          ## ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          
          | å¹³å° | æœ€ä½ç‰ˆæœ¬ |
          |------|---------|
          | Windows | Windows 10 (64ä½) |
          | macOS | macOS 10.13 |
          | Linux | æ”¯æŒ GTK3 çš„ç°ä»£å‘è¡Œç‰ˆ |
          
          **ç‰ˆæœ¬ï¼š** ${VERSION}  
          **å‘å¸ƒæ—¥æœŸï¼š** $(date +'%Y-%m-%d')
          RELEASE_NOTES_EOF
          
          # æ˜¾ç¤ºç”Ÿæˆçš„ release notes
          cat release_notes.md
      
      - name: Install zip utility
        run: |
          # ç¡®ä¿ zip å·¥å…·å·²å®‰è£…
          sudo apt-get update && sudo apt-get install -y zip
      
      - name: Prepare release files
        run: |
          mkdir -p ./release
          RELEASE_DIR="$(pwd)/release"
          
          # éå†æ‰€æœ‰ artifact ç›®å½•
          for artifact_dir in ./artifacts/*/; do
            if [ -d "$artifact_dir" ]; then
              # æ£€æŸ¥æ˜¯å¦æ˜¯ .app ç›®å½•
              app_dir=$(find "$artifact_dir" -maxdepth 1 -type d -name "*.app" | head -1)
              if [ -n "$app_dir" ]; then
                # å°† .app ç›®å½•æ‰“åŒ…æˆ zip æ–‡ä»¶
                appname=$(basename "$app_dir")
                zipname="${appname}.zip"
                # ä» .app ç›®å½•çš„çˆ¶ç›®å½•æ‰“åŒ…ï¼Œç¡®ä¿åŒ…å«å®Œæ•´çš„ .app ç›®å½•ç»“æ„
                (cd "$(dirname "$app_dir")" && zip -r "${RELEASE_DIR}/${zipname}" "$appname" -q)
                echo "Created zip: ${zipname}"
              else
                # å¤åˆ¶å…¶ä»–æ–‡ä»¶ï¼ˆLinux å’Œ Windows å¯æ‰§è¡Œæ–‡ä»¶ï¼‰
                find "$artifact_dir" -type f | while read file; do
                  filename=$(basename "$file")
                  cp "$file" "./release/$filename"
                  echo "Copied file: $filename"
                done
              fi
            fi
          done
          
          # ä¸º Linux æ–‡ä»¶æ·»åŠ æ‰§è¡Œæƒé™ï¼ˆä½¿ç”¨é€šé…ç¬¦åŒ¹é…æ‰€æœ‰ Linux å¯æ‰§è¡Œæ–‡ä»¶ï¼‰
          find ./release -type f ! -name "*.exe" ! -name "*.zip" -exec chmod +x {} \; 2>/dev/null || true
          
          # æ˜¾ç¤ºæ”¶é›†åˆ°çš„æ–‡ä»¶
          echo ""
          echo "=== Release files ==="
          ls -lh ./release/
          echo ""
          echo "=== .app bundles (as zip) ==="
          find ./release -name "*.zip" -exec ls -lh {} \;
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Release ${{ steps.tag.outputs.tag }}
          body_path: release_notes.md
          files: ./release/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
